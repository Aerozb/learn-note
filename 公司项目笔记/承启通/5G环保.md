# MQTT和Netty关系

MQTT（Message Queuing Telemetry Transport）是一种基于发布/订阅模式的消息传输协议，通常用于物联网设备之间的通信。而Netty是一个高性能的网络应用框架，提供了异步事件驱动的网络应用程序开发方式。它们之间的关系在于，Netty可以作为MQTT协议的实现框架之一。通过Netty，开发人员可以轻松地构建自己的MQTT服务器或客户端，利用Netty的高性能和灵活性来处理MQTT协议的通信。因此，Netty提供了一种方便的方式来实现MQTT协议的功能。

# 为什么不用MQTT服务

MQTT是发布/订阅模式的消息，设备端掉线，服务端无法主动收到通知，而netty能监听到下线

MQTT本身在传统的形式下确实无法立即知道设备掉线。但是，基于Netty构建的MQTT服务器可以利用Netty的事件驱动机制来监听连接状态，从而实现设备掉线时的通知。

Netty作为一个网络应用框架，提供了一套完善的事件模型，可以监听连接的建立和断开事件。在基于Netty实现的MQTT服务器中，可以注册相应的事件处理程序来监听设备的连接状态。当设备连接断开时，服务器就会触发相应的事件，从而可以及时地获取到设备掉线的通知。

因此，虽然MQTT本身无法直接提供设备掉线的通知，但是通过Netty作为底层框架，可以实现对设备连接状态的监听，从而在设备掉线时及时感知到并采取相应的措施。

# mqtt业务梳理

水质检测设备的厂家，用的是mqtt协议传输数据，他们检测完水质数据后，通过mqtt传输给我们，我们发送命令也使用mqtt协议传输，采用的是netty实现的MQTT功能，我们的mqtt单独一个模块，收到设备数据后把消息发到mq，其他服务去消费数据

# 由于服务集群，向设备发送命令怎么保证发到所连接的那个服务

## 前置知识

1. **Channel（通道）**：Channel 是 Netty 中的核心概念之一，代表了一个到远程节点的连接。它类似于 Java NIO 中的 `java.nio.channels.Channel`。Channel 可以用来进行数据的读取、写入和连接状态的管理。在 Netty 中，所有的 I/O 操作都是通过 Channel 完成的。
2. **ChannelId（通道标识符）**：ChannelId 是用来唯一标识一个 Channel 的对象。每个 Channel 在创建时都会被分配一个唯一的 ChannelId。ChannelId 通常用于识别 Channel，以及在需要时进行查找、比较或者存储。ChannelId 的实现类似于 UUID（Universally Unique Identifier），确保了每个 ChannelId 的全局唯一性。

简单来说，Channel 是实际的数据传输通道，负责数据的读写和连接管理；而 ChannelId 则是用来唯一标识和区分不同的 Channel。

## 方案

1. 设备每次连上集群中的一个服务端（比如A服务端），都会发布一个注册主题，A服务端收到后，会往redis写入这个设备id和A服务端的IP地址关系，设备和channelId的关系
2. 以后在后台管理页面对设备发送命令操作（都是请求转发设备命令接口）
3. 其中一个服务端收到后，都会从redis获取到这个设备所属的A服务IP，使用http请求A服务端的发送命令接口
4. A服务端找到设备对应的Channel，然后发送消息

# 如果发送命令失败，怎么重试

使用quartz，在每次发送命令后，动态添加个10秒后执行重新发送任务，如果10秒内收到设备响应成功内容，则把此定时任务删除，否则10秒后出发定时任务，会重试3次发送，才会停止

为什么使用quartz，因为它可以在单机运行，保证只在设备所连接的这个服务执行定时任务，不会跑到其他集群服务中

# 由于以前的水质数据的主键是对方传过来的，现在自己生成的,可能会重复接收到同一条数据怎么解决

1. 以前对接的设备厂家，会传过来一个cid，把cid作为水质数据的主键，
2. 但是现在接入新厂家的设备，使用mqtt协议，收到水质数据，需要自己生成主键
3. 原先方案一，直接生成随机UUID，但是可以发送查询历史数据命令，服务端可能会不断收到重复数据，这样同一条水质数据就会重复插入，所以此方案舍弃
4. 改成使用厂家的设备id+采集时间组成此水质数据的唯一值，因为采集时间是对方发过来数据中可以确定是唯一的，所以这个可以用，插入到水质数据表中有重复就会报错

# 没有oss，导出的数据，由于服务集群，怎么保证下载到

每个服务器特定目录设置了同步，所以生成的excel存放到此目录，然后下载的时候从这目录下载即可，随便请求到那个服务都可以下载到