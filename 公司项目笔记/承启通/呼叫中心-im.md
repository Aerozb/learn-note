# 前提说明

访客/坐席端，im服务，呼叫中心服务之间交互的流程图时序图可以看本md所在目录的IM.drawio

访客端和坐席端会分别和im服务，呼叫中心服务建立websocket链接

和im服务连接是为了聊天用，而和呼叫中心链接是为了查询，保存信息等业务操作，原本可以使用http请求，但是不懂为啥要用websocket

# 登录成功发送导航栏消息（弃用）

登录成功后 (1.websocket连接成功后；2.页面刷新也会重新连接；3.如果断开，在连接也算)

im服务会发送一个登录主题的mq（包含用户类型，用户id，公司，sessionId），呼叫中心接收到消息，进行判断

1. 当用户是访客就发送导航栏信息，请求im服务接口，通过im发送消息给访客

2. 当用户是坐席就更新坐席状态

>  非聊天记录的消息都通过websocket和前端传输，需要保留聊天记录的，就先发到im，im再通过websocket发到前端

# 登录成功发送底部的猜你想问

根据当前用户所属聊天渠道配置机器人id，查询相关已上线的机器人配置的意图例句

# 超时自动结束会话

1. 访客点击 导航栏-转人工 的时候发送一个延时消息到mq，延时分钟从配置的超时分钟获取

2. 每次聊天，都会往redis设置这个会话的超时日期时间

3. 等收到延时消息，根据当前时间和redis上这个会话的超时日期时间对比，大于等于就结束会话，否则重新再发一条延时消息，等待下次超时判断

4.如果进入结束逻辑，坐席接待数就会减1

# 会话列表 推送

推送会话中的列表

推送机制

1. 用户转人工客服成功后主动推送会话列表

2. 客服状态切换空闲/结束会话，分配新访客(如果队列有排队用户的话)，主动推

3. 会话转接成功后，主动推

# 坐席状态切换

客服状态：在线，离线，忙碌

## WS断连处理

**刷新浏览器**：状态切换都由业务im处理，当浏览器刷新时，与业务IM ws断开连接（状态切离线），前端重新进入到客服端页面才创建WS，此时客服状态就还是离线

**断线**：处于客服页面，本来是在线，如果突然与WS断开连接（状态切离线，前端不知道），再重连，前端会根据当前页面的状态重新设置客服状态，这样就能保持客服状态不变



**切成空闲时，触发以下事件**

1. 坐席更新排队信息 -> 更新当前会话数，空闲时间
2. 分配新访客 -> 如果有人在排队，则排进来

​		2.1 客服组客服：先查询当前坐席所属的所有客服组，根据客服组遍历所有排在当前客服组的用户，进行转人工

​		2.2 全公司客服：如果客服组级别转失人工败，则找到属于这个公司的所有客服，查询可以接待的，进行转人工

# 常用语

给坐席端用的，快捷发送

后台配置管理区新增通用的，也可以在坐席端新增自有的

# 渠道

渠道账号：各个平台的可以调用api来跟用户聊天的账号，比如微信公众号，whatsapp business账号等，并不是普通的用户账号（这种官方没提供聊天api）

客服：我们平台自己实现的客服，接收来自账号的消息，可以接收来自所有平台的消息

多个平台的消息->多平台账号 -> 我们的客服



接入国内外多个平台（微信公众，TG,INS啥的）的聊天接口，监听到客户发送的消息发到我们的新IM服务，我们通过对接的接口，收到消息后，调用转人工方法发给坐席，坐席收到后回复消息，在调用接入的接口给平台发消息。等于平台的消息中间转一层给到坐席，聊天用websocket实现

# 工作时间设置

<img src="./assets/image-20240625170854722.png" alt="image-20240625170854722" style="zoom: 50%;" />

用户转人工客服时会根据配置找有在工作时间内的

**常规工作时间**：指的是常规客服要上班的时间例如周一到周五

**非常规工作时间**：适用于节假日值班的时候，例如端午节、国庆节需要值班。

同一公司下同一客服组只能配置一次（非）常规工作时间，即公司-客服组-（非）常规类型 是唯一的



由于客服可以再多个小组内，怎么知道用哪个呢？

答：因为账号是属于某个渠道（平台），可以配置这个平台下的账号对应组，所以可以找到指定的组



<img src="./assets/image-20240625173231083.png" alt="image-20240625173231083" style="zoom: 50%;" />



# 社媒渠道接入

帮忙托管各个平台的账号，用于接收来自用户的消息转发给我们呼叫中心平台的客服（坐席）

用户 -> 社媒账号 -> 呼叫中心平台收到社媒的消息回调 -> 发给聊天用的im服务 -> 发给前端，客服收到 -> 结束

# 已读功能

方案一（废弃）

客服每次点会话列表中的某一个就会请求更新聊天记录为已读接口

但是聊天记录根据时间分表，这样一来就得查询所有分表，这样就会很耗费性能，所以获取会话列表的时候要返回最早未读的一条聊天记录时间，这个就是查询分表需要的起始时间，就能大大减少性能的消耗，结束时间就是现在

方案二

放在会话列表字段这边，每次有新消息，就把当前会话记录改成未读，前端根据这个字段显示红点

# 收发消息大致流程

**访客**（前端客户端）：即APP和web端，临时登录我们制作的客户端

**社媒渠道用户**（客户端）：在第三方平台发送消息的用户，即微信，facebook等发送给某个专门收消息的账户

**客服**（前端客户端）：坐席端，有app，web，各个社媒渠道（ins，微信等）

**呼叫中心-im模块**（java客户端）：集成了im框架的客户端SDK，业务处理，如转人工，收到消息调用意图识别

**linkcircle-im**（java服务端）：购买的一个im框架，此服务只单纯做收发消息，即聊天内容入库



**websocket建立链接关系**

访客 <-> linkcircle-im <-> 客服 ：用于聊天消息流转 ------ 访客发消息到服务端，服务端再去转给客服

访客 <-> 呼叫中心-im模块 <-> 客服 ：用于发送业务消息 ------ 1. 给访客发送猜你想问，转人工是否成功等业务消息；2. 给客服发送会话列表，常用语，转接等业务消息

呼叫中心-im模块 <-> linkcircle-im ：社媒渠道用户不直接建立，间接建立，呼叫中心-im模块收到社媒渠道用户的消息后，与linkcircle-im建立连接

**凡是有消息经过im服务端，就会发两个方法**

1. 处理客服消息：java客户端，im框架的监听消息方法onRecieveMessage，会处理收到来自客服的消息(从app或者web端发出的消息)，调用各个社媒渠道发送消息方法，发给用户
2. 处理用户消息：im服务端收到消息后发送一条mq消息，java客户端消费主题为im_save_msg的消息，判断是社媒的消息，就走转人工或意图，是坐席的就不处理

**用户发消息流程/客服收消息流程**

1. 用户发送消息

   1.1 访客：直接发到linkcircle-im服务端

   1.2 社媒渠道用户：在呼叫中心-im模块各自接收到平台的消息通知，然后调用linkcircle-im框架的登录接口模拟登陆，获取在im中的用户id（根据这用户id，后续客服才能发送给此用户），登录成功向linkcircle-im服务端发送消息

2. linkcircle-im服务端收到，发送一条mq消息

3. linkcircle-im服务端和呼叫中心-im分别消费这条mq消息

   3.1 linkcircle-im服务端：消息入库

   3.2 呼叫中心-im：进行消息的意图识别，进行智能回复，就是用户会收到消息；或者判断是否转人工，跟客服进行聊天，就是客服会收到消息；会话服务记录创建

**用户收消息流程/客服发消息流程**

1. 客服回复用户，从web或app端（客户端）发一条消息

2. im服务端收到后，已经知道此用户在im中的用户id，通过ws转发给这个用户（估计是存了个map，保存用户id和ws连接关系）

   2.1 访客：web或app端，也有im框架提供的SDK，监听到收到消息，直接就展示

   2.2 社媒渠道用户：呼叫中心-im模块（客户端），有方法监听到，收到消息后，在调用各自的社媒渠道发送方法，就能发过去

# SendMsgUtil 发给指定用户消息工具类

由于ws服务端集群，有多个服务，A用户随机连接到A服务，但是想在B服务直接发送消息给A是不行的，B服务并没有和A用户建立连接，所以需要再A用户所连接的A服务去发送，具体怎么做呢，看下面

本项目ws连接使用netty实现，所以在建立连接的时候，保存A用户的channelId和连接到A服务的ip，B服务在请求此IP，去调用发消息给用户，实际就是A服务去调用发消息了，这样就能成功

forward：转发，去http调用B服务IP的发送消息接口

sendMsg：真实发送，根据channelId去发送

# 实体和变量区别

实体：主动发送给用户，用户填写完收集 结果赋值到实体，实际也是个变量，定义不一样而已

变量：被动收集用户的聊天内容，赋值到变量

